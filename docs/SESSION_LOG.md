# Session Log

## 2026-02-24
Fixed permission modal scroll — root cause was three issues combined: .slice(0, 500) truncated plan content before it could overflow the container, Tailwind v4 wasn't applying critical flex/overflow classes (fixed with inline styles for maxHeight, flex, flexShrink, minHeight, overflowY), and the modal rendered inside an overflow:hidden ancestor in ProjectWorkspace (fixed with React Portal to document.body). Diagnosed systematically using Puppeteer with iPhone emulation and CDP touch simulation to prove CSS was correct, then deployed debug overlay showing scrollHeight/clientHeight/overflow to pinpoint the real issue. Rebranded app from "Claude Code Mobile" to "Code Anvil Mobile" — updated all UI text, README, CLAUDE.md, replaced Claude asterisk logo with cartoon anvil SVG in blue accent. Renamed public GitHub repo to code-anvil-mobile-public, updated git remote and publish script. Added Fork/Undo/New action bar to embedded ChatInterface (these buttons existed but were hidden when embedded in ProjectWorkspace). Added glowing green version badge (v1.2.0) to sign-in page. Completed v1.2.0 testing — graceful interrupt and session persistence passed; removed Fork button (SDK has no session switcher to navigate between forks) and Undo button (rewindFiles only works on active queries, useless after Claude finishes). Added file browser refresh button and auto-refresh on tab switch. Renamed private repo to code-anvil-mobile, updated git remote, Vercel URL (codeanvilmobile-sigma.vercel.app), and Google OAuth settings. Merged dev to main, published v1.2.0 to public repo, audited public repo for PII — clean.

## 2026-02-21
Implemented v1.2.0 SDK feature expansion (17 files, 839 insertions, 6 batches) and began dev branch testing. UX fixes pushed to dev: New Folder button positioning in empty folders, custom number inputs for budget cap and turn limits, permission modal [object Object] fix for complex tool inputs (AskUserQuestion), permission timeout increased to 2 minutes. Open issue: permission modal detail area (plan content) not scrollable despite multiple attempts (Tailwind max-h, flex tricks, inline styles) — needs further debugging on mobile. Cleaned up .publicignore (strips scripts/, .publicignore, Start CC Server Local.command from public repo), deleted outdated IMPLEMENTATION_PLAN.md. Set up dev worktree cc-server on iMac with .env copied from main. Next: fix permission modal scroll, continue testing v1.2.0 features on dev, then merge to main and publish to public repo.

## 2026-02-17
Added Vitest testing infrastructure to both root and cc-server — installed vitest, created configs, wrote 41 tests across 3 files (QueryRunner event buffering/replay/registry, SSE stream parser chunking/edge cases, auth middleware all code paths). Ran comprehensive codebase + Agent SDK audit identifying 16 untapped SDK capabilities (file checkpointing/rewind, mid-query model switch, cost limits, dynamic MCP, structured output, 1M context beta, custom subagents) and major mobile UX gaps (no file editing, no diff viewer, no git visibility). Created detailed plan for ~90 more integration tests covering all Express routes. Next: implement the integration test plan.

## 2026-02-16
Bulletproof status and reconnect — decoupled query/command execution from SSE connection lifetime so the server keeps working when phones suspend background tabs. Created QueryRunner class (cc-server/src/query-runner.ts) with indexed event buffer (2000 cap), listener management, replay-from-index, and registry with auto-cleanup. Refactored chat.ts POST handler to buffer events through QueryRunner — res.on("close") now removes the listener but does NOT abort the query. Added GET /status and POST /reconnect endpoints for both chat and terminal. Created TerminalRunner with same pattern — process no longer killed on disconnect, orphaned processes auto-killed after 30min. Added 4 Vercel proxy routes (chat/status, chat/reconnect, terminal/status, terminal/reconnect). Frontend: extracted handleSSEEvent callback shared by sendMessage and reconnect flows, replaced aggressive 3s abort-on-visibility with instant status check + reconnect, added periodic health poll (10s) during streaming with staleness detection (20s), smart retry that reconnects if query exists vs resends if gone, network offline now marks disconnected without aborting. Rich status: expanded ActivityState to include tool-running (with toolName/description) and agent-working (description from Task tool), created StatusBar component with connection health dot (green pulse/blue spinner/amber/red), activity labels, and elapsed time counter — always visible during streaming above input area. Terminal reconnect: track commandId and lastEventIndex per entry, visibility handler checks status and reconnects, abort fallback tries reconnect before marking done. Next: restart cc-server on iMac to activate.


