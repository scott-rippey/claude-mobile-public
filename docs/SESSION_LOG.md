# Session Log

## 2026-02-14
Full robustness and SDK capabilities audit — added SSE heartbeat keepalives (15s) to chat and terminal streams, fixed terminal proxy 10s timeout that killed long commands, added graceful app-resume with 3s grace period and retry button on connection loss, session cleanup with 24h TTL, network offline/online detection with warning banner, browse path persistence (sessionStorage), terminal command history persistence (localStorage, capped at 100). SDK enhancements: forward compact_boundary events showing tokens freed, call supportedModels()/mcpServerStatus() after init and send to client, /model now shows available models list, abort signal race fix, error format standardization. Observability: global unhandled rejection/exception handlers, periodic resource logging (sessions/aborts/permissions every 60s), permission timeout reduced to 60s with 45s warning.

## 2026-02-13
Added stop button and permission system — switched from bypassPermissions to default permission mode with canUseTool callback, mobile-friendly permission modal (Allow/Deny), red stop button to abort active queries (client + server-side), new /abort and /permission routes and API proxies. Fixed context token tracking — was using cumulative usage across all API turns instead of per-turn usage from individual assistant messages, causing wildly inflated numbers (e.g. 153k shown for a 31k context). Fixed git push failures for Clarity, ScottMichaelMedia, and slash-commands repos by adding PAT to remote URLs. Fixed workspace link hidden during error/loading states — moved "Open Workspace" link outside the loading/error/success conditional in FileBrowser so it always renders on browse pages; previously API errors caused early return hiding all navigation. Added new folder creation with auto-navigate into the new folder, and empty-directory hint in embedded mode pointing to Chat tab. Fixed empty folder Start Coding Here button not appearing — entries/loading/error state was not reset when path changed, so stale data from previous folder hid the button; also improved empty state UX with centered folder icon and prominent CTA, added "Open Workspace Anyway" escape hatch on API errors, and fixed URL encoding for folder names with spaces. Persisted chat history to localStorage across navigation.

## 2026-02-12
Fixed terminal proxy body consumption bug and reverted to SSE pass-through (matching chat route) after discovering await res.text() hangs on open streams. Added AuthGuard with localStorage validation flag so clearing browser cache forces re-login. Extracted LogoutButton component and added it to all browse pages and project workspace. Added /api/terminal/test diagnostic endpoint and verbose logging throughout proxy and cc-server terminal route. Fixed Start CC Server.command to auto-kill stale port 3002 processes and auto-restart on crash. Fixed terminal kill bug — `req.on("close")` fires when Express finishes consuming the POST body, not on client disconnect; changed to `res.on("close")`. Moved cc-server from port 3002 to 3020 to avoid conflicts with Next.js dev server. Added Chat tab to project workspace (was only accessible via direct URL). Added back button to browse pages and home button to project workspace header for mobile navigation. Added local-only server launcher (`Start CC Server Local.command`). Implemented full Claude Code SDK parity: changed settingSources to load project+user+local settings (MCP servers, plugins, user CLAUDE.md), switched to bypassPermissions for headless mode, removed hardcoded MCP/allowedTools. Forwarded all SDK message types (tool results, tool_progress with elapsed time, full system init with tools/MCP/plugins/skills). Fixed swallowed SDK error results that caused empty "disappearing" messages. Added tool result display in ToolCallIndicator with truncation and Show All toggle. Removed 10s timeout on chat SSE proxy (was killing long SDK init). Added maxDuration=300 to Vercel chat route. Re-enabled bypassPermissions + settingSources ["project", "user"] with allowDangerouslySkipPermissions flag, removed hardcoded allowedTools — SDK now loads user MCP servers, skills, and CLAUDE.md automatically. Simplified server to clean pass-through architecture — stripped all client-side and server-side slash command interception, session state tracking, and special-casing. Server now only expands custom .md commands and passes everything else directly to the SDK. Client only handles /clear locally. Added built-in slash command handlers (/help, /context, /model, /mcp, /status, /clear) with in-memory session state tracking per sessionId — built-in commands return instant responses without calling the SDK, while custom .md commands and /compact pass through to the SDK. Added context usage bar above chat input showing tokens used/remaining with color-coded progress (green/yellow/red). /clear now also notifies server to clean up session state. Reordered workspace tabs to Browse, File, Chat, Terminal, Help. Added Help tab with full explainer of all features, commands (built-in, custom .md, SDK skills), and key behaviors. Rebranded from "CC Interface" to "Claude Code Mobile" — updated sign-in page with Claude logo, page title, SVG favicon, and ClaudeLogo component. Next: restart cc-server on iMac to activate command handlers and context bar token tracking.

## 2026-02-11
Built full CC Interface project: Express server (cc-server) with auth middleware, file browsing, and Claude Agent SDK chat streaming on port 3002; Next.js frontend with file browser, file viewer, chat interface, and NextAuth Google OAuth setup. Restructured project — moved Next.js app to repo root for Vercel, cc-server stays as subfolder. Fixed Vercel build (excluded cc-server from tsconfig/eslint). Deployed to Vercel (claudemobile-sigma.vercel.app), bought claudemobile.dev domain, created Cloudflare Tunnel (api.claudemobile.dev -> localhost:3002). Added terminal backend route (SSE streaming bash commands) and tabbed project workspace (/project/[project]) with Browse, Terminal, and File tabs using CSS hidden for state persistence. Downgraded Next.js 16 to 15.5.12 — v16 deprecated middleware.ts convention which broke Google auth entirely. Fixed terminal proxy — reverted from broken JSON buffering (await res.text() hangs on SSE) to SSE pass-through matching chat route; added 10s timeout to serverFetch for fast cc-server-down errors. Fixed auth cache-clear logout via localStorage validation flag (AuthGuard) — clearing browser cache now forces re-login. Added LogoutButton component to all pages (browse root, subfolders, project workspace). Updated Start CC Server.command with auto-restart loop. Next: restart cc-server on iMac and verify terminal works end-to-end.
