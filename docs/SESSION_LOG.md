# Session Log

## 2026-02-17
Added Vitest testing infrastructure to both root and cc-server — installed vitest, created configs, wrote 41 tests across 3 files (QueryRunner event buffering/replay/registry, SSE stream parser chunking/edge cases, auth middleware all code paths). Ran comprehensive codebase + Agent SDK audit identifying 16 untapped SDK capabilities (file checkpointing/rewind, mid-query model switch, cost limits, dynamic MCP, structured output, 1M context beta, custom subagents) and major mobile UX gaps (no file editing, no diff viewer, no git visibility). Created detailed plan for ~90 more integration tests covering all Express routes. Next: implement the integration test plan.

## 2026-02-16
Bulletproof status and reconnect — decoupled query/command execution from SSE connection lifetime so the server keeps working when phones suspend background tabs. Created QueryRunner class (cc-server/src/query-runner.ts) with indexed event buffer (2000 cap), listener management, replay-from-index, and registry with auto-cleanup. Refactored chat.ts POST handler to buffer events through QueryRunner — res.on("close") now removes the listener but does NOT abort the query. Added GET /status and POST /reconnect endpoints for both chat and terminal. Created TerminalRunner with same pattern — process no longer killed on disconnect, orphaned processes auto-killed after 30min. Added 4 Vercel proxy routes (chat/status, chat/reconnect, terminal/status, terminal/reconnect). Frontend: extracted handleSSEEvent callback shared by sendMessage and reconnect flows, replaced aggressive 3s abort-on-visibility with instant status check + reconnect, added periodic health poll (10s) during streaming with staleness detection (20s), smart retry that reconnects if query exists vs resends if gone, network offline now marks disconnected without aborting. Rich status: expanded ActivityState to include tool-running (with toolName/description) and agent-working (description from Task tool), created StatusBar component with connection health dot (green pulse/blue spinner/amber/red), activity labels, and elapsed time counter — always visible during streaming above input area. Terminal reconnect: track commandId and lastEventIndex per entry, visibility handler checks status and reconnects, abort fallback tries reconnect before marking done. Next: restart cc-server on iMac to activate.

## 2026-02-15
Full security and README audit for public release — ran 4 parallel agents scanning current files, git history, PII, and README completeness. Confirmed publish script already protects public repo (force-pushes single commit, no history exposed). Fixed port bug in server-api.ts (localhost fallback was 3002 instead of 3020). Updated README with cross-platform setup instructions (Mac/Linux/WSL), security considerations, troubleshooting section, local dev instructions, Context7 MCP mention, session state and permission timeout docs. Genericized personal tunnel URL in CLAUDE.md. Bumped to v1.0.1, published to both private and public repos.

## 2026-02-14
Full robustness and SDK capabilities audit — added SSE heartbeat keepalives (15s) to chat and terminal streams, fixed terminal proxy 10s timeout that killed long commands, added graceful app-resume with 3s grace period and retry button on connection loss, session cleanup with 24h TTL, network offline/online detection with warning banner, browse path persistence (sessionStorage), terminal command history persistence (localStorage, capped at 100). SDK enhancements: forward compact_boundary events showing tokens freed, call supportedModels()/mcpServerStatus() after init and send to client, /model now shows available models list, abort signal race fix, error format standardization. Observability: global unhandled rejection/exception handlers, periodic resource logging (sessions/aborts/permissions every 60s), permission timeout reduced to 60s with 45s warning. Added real-time activity feedback during agentic work — enabled SDK partial message streaming (includePartialMessages), forwarding content_block_start/delta/stop stream events to client, token-by-token text streaming with dedup against full assistant messages, and ActivityIndicator state machine that shows "Thinking..." between tool calls and "Preparing tool call..." before tool execution (eliminates dead air during multi-tool interactions). Added paragraph breaks between text segments before/after tool calls for readability. Fixed broken context token tracking — was extracting usage from assembled assistant messages which had no usage data, causing the context bar to show stale ~37% regardless of actual usage; now extracts per-turn usage from message_start stream events and sends live context_update events to the client so the context bar updates in real-time during multi-tool conversations. Added mode selector — three-mode segmented control (Default/Accept Edits/Plan) in chat UI with live mid-session switching via SDK setPermissionMode(); mode persisted in session state, new /api/chat/mode route, disabled during streaming, resets on new conversation. Sanitized codebase for public sharing — moved hardcoded tunnel token from Start CC Server.command to cc-server/.env, moved hardcoded allowed email from lib/auth.ts to ALLOWED_EMAILS env var, replaced personal paths/URLs in .env.example files with generic placeholders, rewrote docs/IMAC_SETUP.md as generic server setup guide. Created public repo infrastructure — README.md with full setup guide (Google OAuth, Cloudflare Tunnel, Vercel deployment), MIT LICENSE, .publicignore for selective file exclusion, and scripts/publish-public.sh for filtered push to public remote. Published v1.0.0 to public repo (scott-rippey/claude-mobile-public) — added public git remote, ran publish script that strips private docs and pushes filtered branch. Updated README setup instructions to match current Google Auth Platform UI (Branding/Audience/Clients replaces old APIs & Services navigation) and current Cloudflare Tunnels UI (Networks > Connectors). Bumped version to 1.0.0 in package.json. Next: add TUNNEL_TOKEN to cc-server/.env on iMac, restart cc-server.

## 2026-02-13
Added stop button and permission system — switched from bypassPermissions to default permission mode with canUseTool callback, mobile-friendly permission modal (Allow/Deny), red stop button to abort active queries (client + server-side), new /abort and /permission routes and API proxies. Fixed context token tracking — was using cumulative usage across all API turns instead of per-turn usage from individual assistant messages, causing wildly inflated numbers (e.g. 153k shown for a 31k context). Fixed git push failures for Clarity, ScottMichaelMedia, and slash-commands repos by adding PAT to remote URLs. Fixed workspace link hidden during error/loading states — moved "Open Workspace" link outside the loading/error/success conditional in FileBrowser so it always renders on browse pages; previously API errors caused early return hiding all navigation. Added new folder creation with auto-navigate into the new folder, and empty-directory hint in embedded mode pointing to Chat tab. Fixed empty folder Start Coding Here button not appearing — entries/loading/error state was not reset when path changed, so stale data from previous folder hid the button; also improved empty state UX with centered folder icon and prominent CTA, added "Open Workspace Anyway" escape hatch on API errors, and fixed URL encoding for folder names with spaces. Persisted chat history to localStorage across navigation.


